# BiliHealth Scan (ä¸€é”®ä¸‰è¿å¥åº·æ¢é’ˆ)

[English](#english) | [ä¸­æ–‡](#chinese)

<div align="center">
  <img src="https://img.shields.io/github/stars/ch777777/BiliHealth-Scan?style=social" alt="GitHub Stars">
  <img src="https://img.shields.io/github/forks/ch777777/BiliHealth-Scan?style=social" alt="GitHub Forks">
  <img src="https://img.shields.io/github/license/ch777777/BiliHealth-Scan" alt="License">
  <img src="https://img.shields.io/greasyfork/dt/538031" alt="Greasy Fork Downloads">
  <img src="https://img.shields.io/greasyfork/v/538031" alt="Version">
</div>

<div align="center">
  <h3>ğŸ¯ ç²¾å‡†è¯„ä¼° | ğŸš€ å®æ—¶åˆ†æ | ğŸ’¡ æ™ºèƒ½æ¨è</h3>
</div>

<a name="english"></a>
## English

### Introduction
BiliHealth Scan is a powerful browser extension that provides real-time visualization of interaction data for Bilibili videos. It automatically displays like rates, coin rates, favorite rates, share rates, and comprehensive ratings, helping users quickly assess video popularity and quality.

### Features
- Automatic calculation and display of interaction rates (likes, coins, favorites, shares) and comprehensive ratings
- Support for multiple Bilibili pages (homepage, video page, search page, partitions, user space, history)
- One-click copy of rating tags for easy sharing
- Smart adaptation to Bilibili's dark/light mode
- Automatic rating refresh when switching pages
- Low performance impact for smooth experience

### Installation
1. Install a userscript manager (Tampermonkey, Violentmonkey, etc.)
2. Visit [Greasy Fork](https://greasyfork.org/zh-CN/scripts/538031-b%E7%AB%99-bilibili-%E5%93%94%E5%93%A9%E5%93%94%E5%93%A9-%E4%B8%80%E9%94%AE%E4%B8%89%E8%BF%9E%E5%81%A5%E5%BA%B7%E6%8E%A2%E9%92%88-bilihealth-scan)
3. Click "Install" to add the script to your browser

### Rating System
The comprehensive rating is calculated using the following weights:
- Like Rate: 1.5
- Coin Rate: 4.0
- Favorite Rate: 3.0
- Share Rate: 2.0

Rating Levels:
- ğŸŒˆ Perfect (â‰¥100%)
- ğŸ”¥ Overwhelmingly Positive (95-99%)
- â­ Very Positive (80-94%)
- ğŸ‘ Mostly Positive (70-79%)
- ğŸ¤” Mixed (40-69%)
- ğŸ˜ Mostly Negative (20-39%)
- âŒ Overwhelmingly Negative (<20%)

### Project Metrics

<div align="center">
  <img src="https://star-history.com/ch777777/BiliHealth-Scan.svg" alt="Star History Chart">
</div>

| Metric | Value | Trend |
|--------|-------|--------|
| GitHub Stars | ![GitHub Stars](https://img.shields.io/github/stars/ch777777/BiliHealth-Scan?style=social) | ğŸ“ˆ |
| Greasy Fork Installs | ![Greasy Fork Installs](https://img.shields.io/greasyfork/dt/538031) | ğŸ“ˆ |
| Current Version | ![Version](https://img.shields.io/greasyfork/v/538031) | ğŸ”„ |
| License | ![License](https://img.shields.io/github/license/ch777777/BiliHealth-Scan) | ğŸ“„ |

### Disclaimer
All data comes from publicly available Bilibili information. The rating algorithm is based on statistical models and may not fully represent video quality. Users should use their own judgment when interpreting ratings.

---

<a name="chinese"></a>
## ä¸­æ–‡

### ç®€ä»‹
ä¸€é”®ä¸‰è¿å¥åº·æ¢é’ˆï¼ˆBiliHealth Scanï¼‰æ˜¯ä¸€æ¬¾å¼ºå¤§çš„æµè§ˆå™¨æ‰©å±•ï¼Œç”¨äºBç«™è§†é¢‘äº’åŠ¨æ•°æ®çš„å¯è§†åŒ–å±•ç¤ºã€‚è‡ªåŠ¨æ˜¾ç¤ºç‚¹èµç‡ã€æŠ•å¸ç‡ã€æ”¶è—ç‡ã€è½¬å‘ç‡åŠç»¼åˆè¯„åˆ†ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿåˆ¤æ–­è§†é¢‘çƒ­åº¦ä¸è´¨é‡ã€‚

### ä¸»è¦åŠŸèƒ½
- è‡ªåŠ¨è®¡ç®—å¹¶å±•ç¤ºç‚¹èµã€æŠ•å¸ã€æ”¶è—ã€è½¬å‘ç­‰äº’åŠ¨ç‡åŠç»¼åˆè¯„åˆ†
- æ”¯æŒé¦–é¡µã€è§†é¢‘é¡µã€æœç´¢é¡µã€åˆ†åŒºã€ç©ºé—´ã€å†å²ç­‰å¤šç§Bç«™é¡µé¢
- è¯„åˆ†æ ‡ç­¾ä¸€é”®å¤åˆ¶ï¼Œä¾¿äºåˆ†äº«
- æ™ºèƒ½é€‚é…Bç«™æ·±è‰²/æµ…è‰²æ¨¡å¼
- è¯„åˆ†å±•ç¤ºéšé¡µé¢åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
- æä½æ€§èƒ½å ç”¨ï¼Œä½“éªŒæµç•…

### å®‰è£…æ–¹æ³•
1. å®‰è£…ç”¨æˆ·è„šæœ¬ç®¡ç†å™¨ï¼ˆå¦‚ï¼šTampermonkeyã€Violentmonkeyç­‰ï¼‰
2. è®¿é—® [Greasy Fork](https://greasyfork.org/zh-CN/scripts/538031-b%E7%AB%99-bilibili-%E5%93%94%E5%93%A9%E5%93%94%E5%93%A9-%E4%B8%80%E9%94%AE%E4%B8%89%E8%BF%9E%E5%81%A5%E5%BA%B7%E6%8E%A2%E9%92%88-bilihealth-scan)
3. ç‚¹å‡»"å®‰è£…"å°†è„šæœ¬æ·»åŠ åˆ°æµè§ˆå™¨

### è¯„åˆ†ç³»ç»Ÿ
ç»¼åˆè¯„åˆ†ä½¿ç”¨ä»¥ä¸‹æƒé‡è®¡ç®—ï¼š
- ç‚¹èµç‡æƒé‡ï¼š1.5
- æŠ•å¸ç‡æƒé‡ï¼š4.0
- æ”¶è—ç‡æƒé‡ï¼š3.0
- è½¬å‘ç‡æƒé‡ï¼š2.0

è¯„åˆ†ç­‰çº§ï¼š
- ğŸŒˆ æ»¡åˆ†ç¥ä½œï¼ˆâ‰¥100%ï¼‰
- ğŸ”¥ å¥½è¯„å¦‚æ½®ï¼ˆ95-99%ï¼‰
- â­ éå¸¸å¥½è¯„ï¼ˆ80-94%ï¼‰
- ğŸ‘ å¤šåŠå¥½è¯„ï¼ˆ70-79%ï¼‰
- ğŸ¤” è¤’è´¬ä¸ä¸€ï¼ˆ40-69%ï¼‰
- ğŸ˜ å¤šåŠå·®è¯„ï¼ˆ20-39%ï¼‰
- âŒ å·®è¯„å¦‚æ½®ï¼ˆ<20%ï¼‰

### é¡¹ç›®æŒ‡æ ‡

<div align="center">
  <img src="https://star-history.com/ch777777/BiliHealth-Scan.svg" alt="Star History Chart">
</div>

| æŒ‡æ ‡ | æ•°å€¼ | è¶‹åŠ¿ |
|------|------|------|
| GitHub Stars | ![GitHub Stars](https://img.shields.io/github/stars/ch777777/BiliHealth-Scan?style=social) | ğŸ“ˆ |
| Greasy Fork å®‰è£…é‡ | ![Greasy Fork Installs](https://img.shields.io/greasyfork/dt/538031) | ğŸ“ˆ |
| å½“å‰ç‰ˆæœ¬ | ![Version](https://img.shields.io/greasyfork/v/538031) | ğŸ”„ |
| å¼€æºåè®® | ![License](https://img.shields.io/github/license/ch777777/BiliHealth-Scan) | ğŸ“„ |

### å…è´£å£°æ˜
æœ¬è„šæœ¬æ‰€æœ‰æ•°æ®å‡æ¥è‡ªBç«™å…¬å¼€ä¿¡æ¯ï¼Œè¯„åˆ†ç®—æ³•åŸºäºç»Ÿè®¡å­¦æ¨¡å‹ï¼Œä¸èƒ½å®Œå…¨ä»£è¡¨è§†é¢‘è´¨é‡ã€‚ç”¨æˆ·åº”ç»“åˆè‡ªèº«åˆ¤æ–­ä½¿ç”¨ï¼Œå¼€å‘è€…ä¸å¯¹è¯„åˆ†ç»“æœæ‰¿æ‹…ä»»ä½•è´£ä»»ã€‚

## Links
- [Greasy Fork](https://greasyfork.org/zh-CN/scripts/538031-b%E7%AB%99-bilibili-%E5%93%94%E5%93%A9%E5%93%94%E5%93%A9-%E4%B8%80%E9%94%AE%E4%B8%89%E8%BF%9E%E5%81%A5%E5%BA%B7%E6%8E%A2%E9%92%88-bilihealth-scan)
- [GitHub Repository](https://github.com/ch777777/BiliHealth-Scan)

# æƒé‡è®¡ç®—é€»è¾‘

åœ¨"ä¸€é”®ä¸‰è¿å¥åº·æ¢é’ˆ"è„šæœ¬ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€å¥—åŠ æƒè®¡ç®—æ–¹æ³•æ¥è¯„ä¼°è§†é¢‘çš„äº’åŠ¨ç‡ï¼Œå¹¶å°†å…¶è½¬åŒ–ä¸ºå¥½è¯„ç‡ã€‚

## äº’åŠ¨æ•°æ®æ ‡å‡†åŒ–

åœ¨è¿›è¡Œè®¡ç®—ä¹‹å‰ï¼Œé¦–å…ˆé€šè¿‡ `normalizeData(rawData)` å‡½æ•°å¯¹ä» Bilibili API è·å–çš„åŸå§‹ç»Ÿè®¡æ•°æ®è¿›è¡Œæ ‡å‡†åŒ–å¤„ç†ï¼Œç¡®ä¿æ’­æ”¾é‡ï¼ˆviewï¼‰ã€ç‚¹èµï¼ˆlikeï¼‰ã€æŠ•å¸ï¼ˆcoinï¼‰ã€æ”¶è—ï¼ˆfavoriteï¼‰ã€åˆ†äº«ï¼ˆshareï¼‰å­—æ®µéƒ½å­˜åœ¨ä¸”ä¸ºéè´Ÿæ•´æ•°ã€‚

```javascript
normalizeData(rawData) {
    return {
        view: parseInt(rawData.view) || 0,
        like: parseInt(rawData.like) || 0,
        coin: parseInt(rawData.coin) || 0,
        favorite: parseInt(rawData.favorite) || 0,
        share: parseInt(rawData.share) || 0
    };
}
```

## åŠ æƒäº’åŠ¨æ¯”ç‡è®¡ç®—

æ ¸å¿ƒçš„åŠ æƒäº’åŠ¨æ¯”ç‡è®¡ç®—åœ¨ `calculateWeightedRatio(data)` å‡½æ•°ä¸­å®Œæˆã€‚

```javascript
calculateWeightedRatio(data) {
    // æ’­æ”¾é‡å°äº1000çš„è§†é¢‘ç›´æ¥è¿”å›0ï¼ˆæ­¤åˆ¤æ–­åœ¨getDisplayRatioä¸­å¤„ç†æ›´å…¨é¢ï¼‰
    // if (data.view < 1000) return 0;

    const weightedInteractions =
        (data.like * this.WEIGHTS.like) +
        (data.coin * this.WEIGHTS.coin) +
        (data.favorite * this.WEIGHTS.favorite) +
        (data.share * this.WEIGHTS.share);

    // è®¡ç®—åŠ æƒäº’åŠ¨æ¯”ç‡å¹¶ä¹˜ä»¥300ä½œä¸ºåŸºç¡€å€¼
    return ((weightedInteractions / data.view) * 100 * 3).toFixed(2);
}
```

è¿™é‡Œä½¿ç”¨äº† `INTERACTION_WEIGHTS` å¸¸é‡æ¥å®šä¹‰ä¸åŒäº’åŠ¨ç±»å‹çš„æƒé‡ï¼š

```javascript
const INTERACTION_WEIGHTS = {
    like: 1,
    coin: 8,
    favorite: 4,
    share: 6,
};
```

æ ¹æ®è¿™äº›æƒé‡ï¼ŒæŠ•å¸å’Œåˆ†äº«åœ¨è®¡ç®—æ—¶å¯¹æ€»åˆ†çš„å½±å“æ¯”ç‚¹èµå’Œæ”¶è—æ›´å¤§ã€‚è®¡ç®—å‡ºçš„åŠ æƒäº’åŠ¨æ€»å’Œé™¤ä»¥æ’­æ”¾é‡ï¼Œå†ä¹˜ä»¥ 100 å¾—åˆ°ç™¾åˆ†æ¯”ï¼Œæœ€åä¹˜ä»¥ 3 å¾—åˆ°ä¸€ä¸ªåŸºç¡€çš„"æƒé‡äº’åŠ¨æ¯”ç‡"ã€‚

## æ’­æ”¾é‡åˆ†çº§ä¸å¥½è¯„ç‡ä¸Šé™

ä¸ºäº†é¿å…ä½æ’­æ”¾é‡è§†é¢‘å› å¶ç„¶çš„é«˜äº’åŠ¨ç‡è€Œè·å¾—è™šé«˜çš„è¯„åˆ†ï¼Œæˆ‘ä»¬åœ¨ `getDisplayRatio` å‡½æ•°ä¸­å¼•å…¥äº†æ’­æ”¾é‡åˆ†çº§å’Œå¯¹åº”çš„å¥½è¯„ç‡ä¸Šé™ã€‚è¿™æ˜¯æ‚¨æœ€è¿‘ä¼˜åŒ–çš„éƒ¨åˆ†ã€‚

```javascript
// å®šä¹‰æ’­æ”¾é‡é˜ˆå€¼å’Œå¯¹åº”çš„æœ€å¤§å¥½è¯„ç‡ä¸Šé™
const VIEW_THRESHOLDS = [
    { view: 1000, maxRatio: 51.99 },    // <= 1åƒæ’­æ”¾é‡ï¼Œå¥½è¯„ç‡ä¸èƒ½æˆåŠŸ52%
    { view: 50000, maxRatio: 68.99 },   // <= 5ä¸‡æ’­æ”¾é‡ï¼Œå¥½è¯„ç‡ä¸èƒ½æˆåŠŸ69%
    { view: 350000, maxRatio: 84.99 },  // <= 35ä¸‡æ’­æ”¾é‡ï¼Œå¥½è¯„ç‡ä¸èƒ½æˆåŠŸ85%
    { view: 500000, maxRatio: 96.99 }   // <= 50ä¸‡æ’­æ”¾é‡ï¼Œå¥½è¯„ç‡ä¸èƒ½æˆåŠŸ97%
];

// ... (åœ¨getDisplayRatioå‡½æ•°ä¸­) ...

let currentRatio = ratio; // åŸå§‹è®¡ç®—å‡ºçš„åŠ æƒäº’åŠ¨æ¯”ç‡

// å¯¹äºæ’­æ”¾é‡å°äº1000çš„è§†é¢‘ï¼Œç›´æ¥è¿”å›0
if (data.view < 1000) return "0.00";

// æ ¹æ®æ’­æ”¾é‡åº”ç”¨å¥½è¯„ç‡ä¸Šé™
for (const threshold of VIEW_THRESHOLDS) {
    if (data.view <= threshold.view) {
        currentRatio = Math.min(currentRatio, threshold.maxRatio);
        //console.log(`[BiliHealth Scan] View ${data.view} <= ${threshold.view}, capped ratio to ${threshold.maxRatio}. Original ratio: ${ratio.toFixed(2)}`); // Debugging log
        break; // æ‰¾åˆ°åŒ¹é…çš„æœ€ä½é˜ˆå€¼ååœæ­¢
    }
}

// åç»­çš„è¯„çº§å’Œå±•ç¤ºéƒ½åŸºäºè¿™ä¸ªåº”ç”¨äº†ä¸Šé™çš„ currentRatio
// ... (è§ è¯„çº§ä¸é¢œè‰²é€»è¾‘ æ–‡æ¡£) ...
```

è¿™æ®µé€»è¾‘ç¡®ä¿äº†ï¼š
-   æ’­æ”¾é‡å°äºç­‰äº 1 åƒçš„è§†é¢‘ï¼Œå¥½è¯„ç‡æœ€é«˜æ˜¾ç¤º 51.99%ã€‚
-   æ’­æ”¾é‡å°äºç­‰äº 5 ä¸‡çš„è§†é¢‘ï¼Œå¥½è¯„ç‡æœ€é«˜æ˜¾ç¤º 68.99%ã€‚
-   æ’­æ”¾é‡å°äºç­‰äº 35 ä¸‡çš„è§†é¢‘ï¼Œå¥½è¯„ç‡æœ€é«˜æ˜¾ç¤º 84.99%ã€‚
-   æ’­æ”¾é‡å°äºç­‰äº 50 ä¸‡çš„è§†é¢‘ï¼Œå¥½è¯„ç‡æœ€é«˜æ˜¾ç¤º 96.99%ã€‚

å¯¹äºæ’­æ”¾é‡é«˜äº 50 ä¸‡çš„è§†é¢‘ï¼Œå°†ä¸å—è¿™äº›ä¸Šé™çš„é™åˆ¶ï¼Œä½¿ç”¨åŸå§‹è®¡ç®—ç»“æœè¿›è¡Œåç»­å¤„ç†ã€‚

è¿™äº›é€»è¾‘å…±åŒæ„æˆäº†è„šæœ¬è¯„ä¼°è§†é¢‘"å¥åº·åº¦"çš„åŸºç¡€ã€‚

---

**æ–‡ä»¶ 4: docs/en/weight_calculation.md (Weight Calculation Logic English)**

```markdown
# Weight Calculation Logic

In the "BiliHealth Scan" script, we use a weighted calculation method to evaluate video interaction rates and translate them into a "Good Rate" (å¥½è¯„ç‡) and overall rating.

## Interaction Data Normalization

Before calculations, the raw statistics obtained from the Bilibili API are normalized using the `normalizeData(rawData)` function. This ensures that the view, like, coin, favorite, and share fields are present and are non-negative integers.

```javascript
normalizeData(rawData) {
    return {
        view: parseInt(rawData.view) || 0,
        like: parseInt(rawData.like) || 0,
        coin: parseInt(rawData.coin) || 0,
        favorite: parseInt(rawData.favorite) || 0,
        share: parseInt(rawData.share) || 0
    };
}
```

## Weighted Interaction Ratio Calculation

The core weighted interaction ratio calculation is performed within the `calculateWeightedRatio(data)` function.

```javascript
calculateWeightedRatio(data) {
    // Videos with less than 1000 views return 0 (handled more comprehensively in getDisplayRatio)
    // if (data.view < 1000) return 0;

    const weightedInteractions =
        (data.like * this.WEIGHTS.like) +
        (data.coin * this.WEIGHTS.coin) +
        (data.favorite * this.WEIGHTS.favorite) +
        (data.share * this.WEIGHTS.share);

    // Calculate the weighted interaction ratio and multiply by 300 as a base value
    return ((weightedInteractions / data.view) * 100 * 3).toFixed(2);
}
```

This function utilizes the `INTERACTION_WEIGHTS` constant to define the weight for each interaction type:

```javascript
const INTERACTION_WEIGHTS = {
    like: 1,
    coin: 8,
    favorite: 4,
    share: 6,
};
```

Based on these weights, coins and shares have a larger impact on the total score than likes and favorites during calculation. The calculated sum of weighted interactions is divided by the view count, multiplied by 100 for a percentage, and finally multiplied by 3 to get a base "Weighted Interaction Ratio".

## View Count Tiers and Good Rate Caps

To prevent low-view count videos from receiving excessively high scores due to chance high interaction rates, we've introduced view count tiers and corresponding good rate caps in the `getDisplayRatio` function. This is your recent optimization.

```javascript
// Define view count thresholds and corresponding maximum good rate caps
const VIEW_THRESHOLDS = [
    { view: 1000, maxRatio: 51.99 },    // <= 1k views, good rate cannot exceed 52%
    { view: 50000, maxRatio: 68.99 },   // <= 50k views, good rate cannot exceed 69%
    { view: 350000, maxRatio: 84.99 },  // <= 350k views, good rate cannot exceed 85%
    { view: 500000, maxRatio: 96.99 }   // <= 500k views, good rate cannot exceed 97%
];

// ... (within the getDisplayRatio function) ...

let currentRatio = ratio; // The originally calculated weighted interaction ratio

// For videos with less than 1000 views, return "0.00" directly
if (data.view < 1000) return "0.00";

// Apply the good rate cap based on view count
for (const threshold of VIEW_THRESHOLDS) {
    if (data.view <= threshold.view) {
        currentRatio = Math.min(currentRatio, threshold.maxRatio);
        //console.log(`[BiliHealth Scan] View ${data.view} <= ${threshold.view}, capped ratio to ${threshold.maxRatio}. Original ratio: ${ratio.toFixed(2)}`); // Debugging log
        break; // Stop after finding the lowest matching threshold
    }
}

// Subsequent rating and display logic are based on this capped currentRatio
// ... (see Rating and Color Logic documentation) ...
```

This logic ensures that:
-   Videos with less than 1000 views display a good rate of 0.00%.
-   Videos with <= 1k views have a maximum displayed good rate of 51.99%.
-   Videos with <= 50k views have a maximum displayed good rate of 68.99%.
-   Videos with <= 350k views have a maximum displayed good rate of 84.99%.
-   Videos with <= 500k views have a maximum displayed good rate of 96.99%.

Videos with more than 500k views are not subject to these caps and use the original calculation results for subsequent processing.

These logic components collectively form the basis for how the script evaluates a video's "health."

---

**æ–‡ä»¶ 5: docs/zh-CN/rating_color_logic.md (è¯„çº§ä¸é¢œè‰²é€»è¾‘ ä¸­æ–‡)**

```markdown
# è¯„çº§ä¸é¢œè‰²é€»è¾‘

"ä¸€é”®ä¸‰è¿å¥åº·æ¢é’ˆ"è„šæœ¬æ ¹æ®è®¡ç®—å‡ºçš„å¥½è¯„ç‡ï¼Œå°†å…¶æ˜ å°„åˆ°ä¸åŒçš„è¯„çº§æ–‡æœ¬å’Œé¢œè‰²ï¼Œä»¥æä¾›ç›´è§‚çš„è§†è§‰åé¦ˆã€‚

## æ˜¾ç¤ºå¥½è¯„ç‡è®¡ç®— (`getDisplayRatio`)

å¦‚[æƒé‡è®¡ç®—é€»è¾‘](weight_calculation.md)ä¸­æ‰€è¿°ï¼Œ`getDisplayRatio` å‡½æ•°é¦–å…ˆè®¡ç®—åŸºç¡€çš„åŠ æƒäº’åŠ¨æ¯”ç‡ï¼Œå¹¶æ ¹æ®æ’­æ”¾é‡åº”ç”¨ä¸Šé™ã€‚åœ¨æ­¤ä¹‹åï¼Œå®ƒè¿˜ä¼šåº”ç”¨ä¸¤ä¸ªé‡è¦çš„é€»è¾‘æ¥ç¡®å®šæœ€ç»ˆæ˜¾ç¤ºçš„"å¥½è¯„ç‡"å­—ç¬¦ä¸²ï¼š

1.  **70% ä»¥ä¸Šå‹ç¼©ï¼š** å¦‚æœåº”ç”¨äº†æ’­æ”¾é‡ä¸Šé™åçš„ `currentRatio` å¤§äºç­‰äº 70ï¼Œè„šæœ¬ä¼šåº”ç”¨ä¸€ä¸ªå‹ç¼©å…¬å¼ï¼š
    ```javascript
    displayRatioValue = (90 + (displayRatioValue - 50) * (10 / (200 - 150)));
    ```
    è¿™ä¸ªå…¬å¼å°† 70% åˆ° 200% ç”šè‡³æ›´é«˜çš„åŸå§‹æ¯”ç‡å‹ç¼©åˆ° 90% åˆ° 100% çš„åŒºé—´ï¼Œä½¿å¾—é«˜åˆ†åŒºåˆ†æ›´åŠ ç´§å‡‘ï¼Œé¿å…è¯„åˆ†è½»æ˜“è¾¾åˆ° 100%ã€‚

2.  **ç‰¹æ®Šè¯„çº§åˆ¤å®šï¼š** åœ¨æ‰€æœ‰æ•°å€¼è®¡ç®—å’Œä¸Šé™åº”ç”¨åï¼Œè„šæœ¬ä¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨æ»¡è¶³ç‰¹å®šé«˜æ’­æ”¾é‡æˆ–é«˜äº’åŠ¨ç‡ç»„åˆæ¡ä»¶çš„è§†é¢‘ã€‚å¦‚æœæ»¡è¶³ä»¥ä¸‹ä»»ä¸€æ¡ä»¶ï¼Œå°†ç›´æ¥è¿”å›ç‰¹æ®Šçš„æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œè¦†ç›–ä»»ä½•è®¡ç®—å‡ºçš„æ•°å€¼ï¼š
    -   æ’­æ”¾é‡ >= 2000 ä¸‡ (`data.view >= 20000000`) -> è¿”å› "å°ç ´ç«™å¿…åˆ·"
    -   æ»¡è¶³ä¸€å®šæ•°é‡çš„å•é¡¹é«˜æ¯”ç‡æ¡ä»¶æˆ–ç‰¹å®šæ’­æ”¾é‡åŒºé—´å†…çš„é«˜äº’åŠ¨ç‡ç»„åˆ (`conditionsMet >= 3 || isSpecialCondition`) -> è¿”å› "å°ç ´ç«™å¿…åˆ·"
    -   æ»¡è¶³ä¸€å®šæ•°é‡çš„å•é¡¹ä¸­é«˜æ¯”ç‡æ¡ä»¶ (`conditionsMet >= 2`) -> è¿”å› "åˆ·åˆ°å¿…çœ‹"
    -   å¦‚æœè®¡ç®—å€¼å¤§äºç­‰äº 100 ä¸”ä¸æ»¡è¶³ä¸Šè¿°ç‰¹æ®Šæ¡ä»¶ -> è¿”å› "100.00"

æœ€ç»ˆ `getDisplayRatio` å‡½æ•°è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¯èƒ½æ˜¯ç™¾åˆ†æ¯”æ•°å€¼ï¼ˆå¦‚ "75.50%"ï¼Œä¸åŒ…å«ç™¾åˆ†å·ï¼‰æˆ–ç‰¹æ®Šæ–‡æœ¬ï¼ˆ"å°ç ´ç«™å¿…åˆ·", "åˆ·åˆ°å¿…çœ‹", "100.00"ï¼‰ã€‚

## è¯„çº§æ–‡æœ¬ä¸é¢œè‰²æ˜ å°„ (`getRating`)

`getRating` å‡½æ•°æ¥æ”¶ `getDisplayRatio` è¿”å›çš„å­—ç¬¦ä¸²ï¼Œå¹¶å°†å…¶æ˜ å°„åˆ°å…·ä½“çš„è¯„çº§æ–‡æœ¬ï¼ˆå¦‚"å¥½è¯„å¦‚æ½®"ï¼‰ä»¥åŠå¯¹åº”çš„ CSS ç±»åã€‚

```javascript
getRating(displayRatio) {
    // ç‰¹æ®Šæ–‡æœ¬è¯„çº§
    if (displayRatio === "å°ç ´ç«™å¿…åˆ·" || displayRatio === "åˆ·åˆ°å¿…çœ‹") {
        return { text: 'æ»¡åˆ†ç¥ä½œ', className: this.RATING_COLORS.rainbow };
    }

    // æ•°å€¼è¯„çº§æ˜ å°„
    const ratioNum = parseFloat(displayRatio);
    if (ratioNum >= 100) return { text: 'æ»¡åˆ†ç¥ä½œ', className: this.RATING_COLORS.rainbow };
    if (ratioNum >= 95) return { text: 'å¥½è¯„å¦‚æ½®', className: this.RATING_COLORS.red };
    if (ratioNum >= 80) return { text: 'éå¸¸å¥½è¯„', className: this.RATING_COLORS.gold };
    if (ratioNum >= 70) return { text: 'å¤šåŠå¥½è¯„', className: this.RATING_COLORS.orange };
    if (ratioNum >= 40) return { text: 'è¤’è´¬ä¸ä¸€', className: this.RATING_COLORS.orangered };
    if (ratioNum >= 20) return { text: 'å¤šåŠå·®è¯„', className: this.RATING_COLORS.limegreen };

    // ä½äº20çš„è¯„çº§
    return { text: 'å·®è¯„å¦‚æ½®', className: this.RATING_COLORS.yellowgreen };
}
```

è¿™é‡Œä½¿ç”¨äº† `RATING_COLORS` å¸¸é‡æ¥å®šä¹‰é¢œè‰²ç±»åä¸é¢œè‰²å€¼çš„å¯¹åº”å…³ç³»ã€‚è¿™äº›ç±»åé€šè¿‡ `GM.addStyle` æ³¨å…¥åˆ°é¡µé¢ä¸­ï¼Œæ§åˆ¶è¯„çº§æ–‡æœ¬çš„é¢œè‰²å’Œå½©è™¹åŠ¨ç”»ã€‚

```javascript
const RATING_COLORS = {
    rainbow: 'rainbow-text',
    red: 'red-text',
    gold: 'gold-text',
    orange: 'orange-text',
    orangered: 'orangered-text',
    limegreen: 'limegreen-text',
    yellowgreen: 'yellowgreen-text',
};
```

æœ€ç»ˆï¼Œæ ¹æ®è®¡ç®—å‡ºçš„å¥½è¯„ç‡ï¼Œè„šæœ¬ä¼šæ˜¾ç¤ºå¸¦æœ‰å¯¹åº”è¯„çº§æ–‡æœ¬å’Œé¢œè‰²æ ·å¼çš„æ ‡ç­¾ã€‚

---

**æ–‡ä»¶ 6: docs/en/rating_color_logic.md (Rating and Color Logic English)**

```markdown
# Rating and Color Logic

The "BiliHealth Scan" script maps the calculated "Good Rate" (å¥½è¯„ç‡) to different rating texts and colors to provide intuitive visual feedback.

## Display Good Rate Calculation (`getDisplayRatio`)

As explained in the [Weight Calculation Logic](weight_calculation.md) documentation, the `getDisplayRatio` function first calculates the base weighted interaction ratio and applies view-based caps. After this, it applies two more important logic steps to determine the final "Good Rate" string to be displayed:

1.  **Compression Above 70%:** If the `currentRatio` (after applying view caps) is 70 or higher, the script applies a compression formula:
    ```javascript
    displayRatioValue = (90 + (displayRatioValue - 50) * (10 / (200 - 150)));
    ```
    This formula compresses raw ratios from 70% up to 200% or more into the 90% to 100% range, making the high score range more granular and preventing the score from easily reaching 100%.

2.  **Special Rating Determination:** After all numerical calculations and caps are applied, the script checks if the video meets specific conditions for high view counts or high interaction rate combinations. If any of the following conditions are met, a special text string is returned directly, overriding any calculated numerical value:
    -   Views >= 20 million (`data.view >= 20000000`) -> Returns "å°ç ´ç«™å¿…åˆ·" (Must-watch on Bilibili)
    -   Meets a certain number of individual high ratio conditions or high interaction combination within specific view tiers (`conditionsMet >= 3 || isSpecialCondition`) -> Returns "å°ç ´ç«™å¿…åˆ·"
    -   Meets a certain number of individual medium-high ratio conditions (`conditionsMet >= 2`) -> Returns "åˆ·åˆ°å¿…çœ‹" (Must-see when you encounter it)
    -   If the calculated value is >= 100 and does not meet the above special conditions -> Returns "100.00"

Finally, the `getDisplayRatio` function returns a string, which can be a numerical percentage value (like "75.50", without the percent sign) or special text ("å°ç ´ç«™å¿…åˆ·", "åˆ·åˆ°å¿…çœ‹", "100.00").

## Rating Text and Color Mapping (`getRating`)

The `getRating` function receives the string returned by `getDisplayRatio` and maps it to a specific rating text (like "Overwhelmingly Positive") and its corresponding CSS class name.

```javascript
getRating(displayRatio) {
    // Special text ratings
    if (displayRatio === "å°ç ´ç«™å¿…åˆ·" || displayRatio === "åˆ·åˆ°å¿…çœ‹") {
        return { text: 'æ»¡åˆ†ç¥ä½œ', className: this.RATING_COLORS.rainbow }; // Masterpiece
    }

    // Numerical rating mapping
    const ratioNum = parseFloat(displayRatio);
    if (ratioNum >= 100) return { text: 'æ»¡åˆ†ç¥ä½œ', className: this.RATING_COLORS.rainbow }; // Masterpiece
    if (ratioNum >= 95) return { text: 'å¥½è¯„å¦‚æ½®', className: this.RATING_COLORS.red }; // Overwhelmingly Positive
    if (ratioNum >= 80) return { text: 'éå¸¸å¥½è¯„', className: this.RATING_COLORS.gold }; // Very Positive
    if (ratioNum >= 70) return { text: 'å¤šåŠå¥½è¯„', className: this.RATING_COLORS.orange }; // Mostly Positive
    if (ratioNum >= 40) return { text: 'è¤’è´¬ä¸ä¸€', className: this.RATING_COLORS.orangered }; // Mixed
    if (ratioNum >= 20) return { text: 'å¤šåŠå·®è¯„', className: this.RATING_COLORS.limegreen }; // Mostly Negative

    // Ratings below 20
    return { text: 'å·®è¯„å¦‚æ½®', className: this.RATING_COLORS.yellowgreen }; // Overwhelmingly Negative
}
```

This function uses the `RATING_COLORS` constant to define the mapping between color class names and their corresponding color values or styles. These class names are injected into the page via `GM.addStyle` and control the color and rainbow animation of the rating text.

```javascript
const RATING_COLORS = {
    rainbow: 'rainbow-text',
    red: 'red-text',
    gold: 'gold-text',
    orange: 'orange-text',
    orangered: 'orangered-text',
    limegreen: 'limegreen-text',
    yellowgreen: 'yellowgreen-text',
};
```

Ultimately, based on the calculated good rate, the script displays a label with the corresponding rating text and color style.

---

**æ–‡ä»¶ 7: docs/zh-CN/homepage_logic.md (ä¸»é¡µé€‚é…é€»è¾‘ ä¸­æ–‡)**

```markdown
# ä¸»é¡µé€‚é…é€»è¾‘

ä¸»é¡µ (`https://www.bilibili.com/`) çš„é€‚é…é€»è¾‘ä¸»è¦é€šè¿‡ `mainPageLogic()` å‡½æ•°å®ç°ã€‚

## æµç¨‹æ¦‚è¿°

1.  åœ¨ `DOMContentLoaded` äº‹ä»¶è§¦å‘ååˆå§‹åŒ–ã€‚
2.  ä½¿ç”¨ `handleCards()` å‡½æ•°å¤„ç†é¡µé¢ä¸Šç°æœ‰çš„è§†é¢‘å¡ç‰‡ã€‚
3.  è®¾ç½® `MutationObserver` ç›‘å¬ `document.body`ï¼Œç”¨äºæ£€æµ‹å’Œå¤„ç†é€šè¿‡æ‡’åŠ è½½æˆ–åŠ¨æ€æ·»åŠ çš„æ–°å¡ç‰‡ã€‚
4.  è®¾ç½®æ»šåŠ¨äº‹ä»¶ç›‘å¬å™¨ï¼Œä½œä¸º `MutationObserver` çš„è¡¥å……ï¼Œç¡®ä¿æ‡’åŠ è½½çš„å¡ç‰‡èƒ½è¢«å¤„ç†ã€‚

## å¡ç‰‡é€‰æ‹©ä¸æ•°æ®æå–

-   è„šæœ¬ä½¿ç”¨ `document.querySelectorAll('div.bili-video-card')` é€‰æ‹©ä¸»é¡µçš„è§†é¢‘å¡ç‰‡ã€‚
-   å¯¹äºæ¯ä¸ªå¡ç‰‡ï¼Œä½¿ç”¨ `card.querySelector('.bili-video-card__image--link')` æŸ¥æ‰¾åŒ…å«è§†é¢‘é“¾æ¥çš„å…ƒç´ ã€‚
-   ä»é“¾æ¥å…ƒç´ çš„ `href` å±æ€§ä¸­é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼ `/bv\w{10}/i` æå– BVIDã€‚
-   ä½¿ç”¨ `processedCards` Set é›†åˆè¿½è¸ªå·²ç»å¤„ç†è¿‡çš„å¡ç‰‡ï¼Œé¿å…é‡å¤å¤„ç†ã€‚

## æ•°æ®è·å–ä¸UIæ³¨å…¥

-   æ”¶é›†éœ€è¦å¤„ç†å¡ç‰‡çš„ BVIDï¼Œç„¶åä½¿ç”¨ `Promise.all` æ‰¹é‡å¼‚æ­¥è°ƒç”¨ `fetchFullStats(bvid)` è·å–ç»Ÿè®¡æ•°æ®ã€‚
-   è·å–åˆ°ç»Ÿè®¡æ•°æ®åï¼Œè°ƒç”¨ `BiliRatingUI.addLikeRateToCard(card, new Map([[bvid, stat]]), bvid)` å‡½æ•°è¿›è¡Œ UI æ³¨å…¥ã€‚
-   `addLikeRateToCard` å‡½æ•°ä¼šï¼š
    -   æŸ¥æ‰¾å¡ç‰‡å†…çš„ç»Ÿè®¡å®¹å™¨ `.bili-video-card__stats--left`ã€‚
    -   åˆ›å»ºç”¨äºæ˜¾ç¤ºè¯„çº§çš„ `<span>` å…ƒç´ ï¼Œå¹¶èµ‹äºˆ `.bili-health-rating-span` ç±»åã€‚
    -   **è·å–ç°æœ‰ç»Ÿè®¡å…ƒç´ çš„å¤§å°ä½œä¸ºå‚è€ƒï¼Œå¹¶åº”ç”¨åˆ°æ–°çš„è¯„åˆ† `<span>` å’Œ SVG å›¾æ ‡ä¸Šï¼Œå®ç°å¤§å°è‡ªé€‚åº”ã€‚**
    -   å°†è®¡ç®—å‡ºçš„å¥½è¯„ç‡å’Œè¯„çº§æ–‡æœ¬åŠé¢œè‰²ç±»åå¡«å……åˆ° `<span>` çš„ `innerHTML` ä¸­ã€‚
    -   **ç®€å•åœ°å°†è¯„åˆ† `<span>` å…ƒç´ è¿½åŠ  (`appendChild`) åˆ°ç»Ÿè®¡å®¹å™¨çš„æœ«å°¾ã€‚**

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä¸»é¡µè§†é¢‘å¡ç‰‡ä¸‹æ–¹ä¼šæ˜¾ç¤ºå¥½è¯„ç‡å’Œè¯„çº§ï¼Œå¹¶ä¸”å…¶å¤§å°ä¼šå°½é‡ä¸æ’­æ”¾é‡ã€å¼¹å¹•æ•°ç­‰ä¿¡æ¯ä¿æŒä¸€è‡´ã€‚

---

**æ–‡ä»¶ 8: docs/en/homepage_logic.md (Homepage Adaptation Logic English)**

```markdown
# Homepage Adaptation Logic

The adaptation logic for the homepage (`https://www.bilibili.com/`) is primarily handled by the `mainPageLogic()` function.

## Process Overview

1.  Initializes after the `DOMContentLoaded` event fires.
2.  Uses the `handleCards()` function to process existing video cards on the page.
3.  Sets up a `MutationObserver` to watch `document.body` for changes, used to detect and process new cards added via lazy loading or dynamic updates.
4.  Sets up a scroll event listener, complementing the `MutationObserver`, to ensure lazy-loaded cards are processed.

## Card Selection and Data Extraction

-   The script selects video cards on the homepage using `document.querySelectorAll('div.bili-video-card')`.
-   For each card, it finds the element containing the video link using `card.querySelector('.bili-video-card__image--link')`.
-   The BVID is extracted from the `href` attribute of the link element using the regular expression `/bv\w{10}/i`.
-   A `processedCards` Set is used to keep track of cards that have already been processed, preventing duplicate work.

## Data Fetching and UI Injection

-   BVIDs from cards needing processing are collected, and `fetchFullStats(bvid)` is called asynchronously in batch using `Promise.all` to get the statistics.
-   Once the statistics are fetched, the `BiliRatingUI.addLikeRateToCard(card, new Map([[bvid, stat]]), bvid)` function is called to inject the UI.
-   The `addLikeRateToCard` function does the following:
    -   Finds the stats container `.bili-video-card__stats--left` within the card.
    -   Creates a `<span>` element for displaying the rating and assigns it the `.bili-health-rating-span` class.
    -   **Gets the size (computed font size and icon height) of existing stat elements as a reference and applies it to the new rating `<span>` and SVG icon, enabling size adaptation.**
    -   Populates the `innerHTML` of the `<span>` with the calculated good rate and rating text/color class.
    -   **Simply appends (`appendChild`) the rating `<span>` element to the end of the stats container.**

In this manner, the good rate and rating are displayed below the video cards on the homepage, and their size attempts to match that of the view count, danmu count, etc.

---

**æ–‡ä»¶ 9: docs/zh-CN/region_page_logic.md (åˆ†åŒºé¡µé€‚é…é€»è¾‘ ä¸­æ–‡)**

```markdown
# åˆ†åŒºé¡µé€‚é…é€»è¾‘

åˆ†åŒºé¡µ (`https://www.bilibili.com/c/*`) çš„é€‚é…é€»è¾‘ä¸»è¦é€šè¿‡ `regionPageLogic()` å‡½æ•°å®ç°ã€‚è¿™éƒ¨åˆ†é€»è¾‘æ˜¯æ‚¨è¿‘æœŸé‡ç‚¹è°ƒè¯•å’Œä¼˜åŒ–çš„ã€‚

## æµç¨‹æ¦‚è¿°

ä¸ä¸»é¡µç±»ä¼¼ï¼Œåˆ†åŒºé¡µçš„é€‚é…é€»è¾‘ä¹Ÿæ˜¯åœ¨ `DOMContentLoaded` ååˆå§‹åŒ–ï¼Œå¹¶ä¾èµ– `handleCards()` å‡½æ•°å¤„ç†ç°æœ‰å¡ç‰‡ï¼Œä»¥åŠ `MutationObserver` å’Œæ»šåŠ¨ç›‘å¬å¤„ç†åŠ¨æ€åŠ è½½çš„æ–°å¡ç‰‡ã€‚

## å¡ç‰‡é€‰æ‹©ä¸æ•°æ®æå–

-   è„šæœ¬ä½¿ç”¨ä¸åŒäºä¸»é¡µçš„é€‰æ‹©å™¨ï¼š`document.querySelectorAll('.bili-cover-card')` æ¥é€‰æ‹©åˆ†åŒºé¡µçš„è§†é¢‘å¡ç‰‡ã€‚
-   **æ•°æ®æå–çš„å…³é”®ç‚¹ï¼š** åœ¨åˆ†åŒºé¡µï¼Œ`.bili-cover-card` å…ƒç´ æœ¬èº«å°±æ˜¯ä¸€ä¸ªé“¾æ¥ (`<a>` æ ‡ç­¾)ã€‚è„šæœ¬ç›´æ¥ä»å¡ç‰‡å…ƒç´ çš„ `href` å±æ€§ä¸­é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼ `/bv\w{10}/i` æå– BVIDã€‚è¿™ä¿®å¤äº†ä¹‹å‰é‡åˆ°çš„æ— æ³•æ­£ç¡®æå– BVID çš„é—®é¢˜ã€‚
-   ä½¿ç”¨ `processedCards` Set é›†åˆè¿½è¸ªå·²å¤„ç†å¡ç‰‡ã€‚

## æ•°æ®è·å–ä¸UIæ³¨å…¥

-   åŒæ ·ï¼Œæ”¶é›†éœ€è¦å¤„ç†å¡ç‰‡çš„ BVIDï¼Œå¹¶æ‰¹é‡å¼‚æ­¥è°ƒç”¨ `fetchFullStats(bvid)` è·å–ç»Ÿè®¡æ•°æ®ã€‚
-   è·å–åˆ°ç»Ÿè®¡æ•°æ®åï¼Œè°ƒç”¨ `BiliRatingUI.addLikeRateToCardForRegion(card, new Map([[bvid, stat]]), bvid)` å‡½æ•°è¿›è¡Œ UI æ³¨å…¥ã€‚
-   `addLikeRateToCardForRegion` å‡½æ•°ä¼šï¼š
    -   æŸ¥æ‰¾å¡ç‰‡å†…çš„ç»Ÿè®¡å®¹å™¨ `.bili-cover-card__stats`ã€‚
    -   åˆ›å»ºç”¨äºæ˜¾ç¤ºè¯„çº§çš„ `<span>` å…ƒç´ ï¼Œå¹¶èµ‹äºˆ `.bili-health-rating-span` ç±»åã€‚
    -   è·å–ç°æœ‰ç»Ÿè®¡å…ƒç´ çš„å¤§å°å‚è€ƒå¹¶åº”ç”¨åˆ°æ–°çš„è¯„åˆ† `<span>` å’Œ SVG å›¾æ ‡ä¸Šï¼Œå®ç°å¤§å°è‡ªé€‚åº”ã€‚
    -   å°†è®¡ç®—å‡ºçš„å¥½è¯„ç‡å’Œè¯„çº§æ–‡æœ¬åŠé¢œè‰²ç±»åå¡«å……åˆ° `<span>` çš„ `innerHTML` ä¸­ã€‚
    -   **å…³é”®çš„æ’å…¥é€»è¾‘ï¼š** è·å–ç»Ÿè®¡å®¹å™¨å†…æ‰€æœ‰çš„ `.bili-cover-card__stat` å…ƒç´ ã€‚å¦‚æœç»Ÿè®¡å…ƒç´ æ•°é‡å¤§äºç­‰äº 2ï¼Œè„šæœ¬ä¼šä½¿ç”¨ `statElements[1].insertAdjacentElement('afterend', ratingSpan)` å°†è¯„åˆ† `<span>` æ’å…¥åˆ°ç¬¬äºŒä¸ªç»Ÿè®¡å…ƒç´ ï¼ˆé€šå¸¸æ˜¯å¼¹å¹•æ•°ï¼‰ä¹‹åã€‚å¦‚æœç»Ÿè®¡å…ƒç´ æ•°é‡å°äº 2ï¼Œåˆ™ä½œä¸ºå›é€€é€»è¾‘ï¼Œç®€å•è¿½åŠ  (`appendChild`) åˆ°ç»Ÿè®¡å®¹å™¨æœ«å°¾ã€‚

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œåˆ†åŒºé¡µè§†é¢‘å¡ç‰‡ä¸Šçš„å¥½è¯„ç‡ä¼šç²¾ç¡®åœ°æ’å…¥åˆ°æ’­æ”¾é‡å’Œå¼¹å¹•æ•°ä¹‹é—´ï¼Œå¹¶ä¿æŒå¤§å°å’Œæ ·å¼ä¸å‘¨å›´å…ƒç´ ä¸€è‡´ã€‚

---

**æ–‡ä»¶ 10: docs/en/region_page_logic.md (Region Page Adaptation Logic English)**

```markdown
# Region Page Adaptation Logic

The adaptation logic for region pages (`https://www.bilibili.com/c/*`) is primarily handled by the `regionPageLogic()` function. This part was a recent focus for debugging and optimization.

## Process Overview

Similar to the homepage, the region page adaptation logic initializes after `DOMContentLoaded` and relies on the `handleCards()` function for existing cards, as well as a `MutationObserver` and scroll listener for dynamically loaded new cards.

## Card Selection and Data Extraction

-   The script uses a different selector than the homepage: `document.querySelectorAll('.bili-cover-card')` to select video cards on region pages.
-   **Key Point for Data Extraction:** On region pages, the `.bili-cover-card` element itself is a link (`<a>` tag). The script extracts the BVID directly from the `href` attribute of the card element using the regular expression `/bv\w{10}/i`. This fixed the previous issue where BVIDs were not being extracted correctly.
-   A `processedCards` Set is used to track processed cards.

## Data Fetching and UI Injection

-   Again, BVIDs from cards needing processing are collected, and `fetchFullStats(bvid)` is called asynchronously in batch to get the statistics.
-   Once the statistics are fetched, the `BiliRatingUI.addLikeRateToCardForRegion(card, new Map([[bvid, stat]]), bvid)` function is called to inject the UI.
-   The `addLikeRateToCardForRegion` function does the following:
    -   Finds the stats container `.bili-cover-card__stats` within the card.
    -   Creates a `<span>` element for displaying the rating and assigns it the `.bili-health-rating-span` class.
    -   Gets the size reference from existing stat elements and applies it to the new rating `<span>` and SVG icon, enabling size adaptation.
    -   Populates the `innerHTML` of the `<span>` with the calculated good rate and rating text/color class.
    -   **Key Insertion Logic:** It gets all `.bili-cover-card__stat` elements within the stats container. If the number of stat elements is greater than or equal to 2, the script uses `statElements[1].insertAdjacentElement('afterend', ratingSpan)` to insert the rating `<span>` after the second stat element (typically the danmu count). If there are fewer than 2 stat elements, it falls back to simply appending (`appendChild`) the rating to the end of the stats container.

In this way, the good rate on region page video cards is precisely inserted between the view count and danmu count, maintaining size and style consistency with surrounding elements.

---

**æ–‡ä»¶ 11: docs/zh-CN/space_page_logic.md (ç©ºé—´ä¸»é¡µé€‚é…é€»è¾‘ ä¸­æ–‡)**

```markdown
# ç©ºé—´ä¸»é¡µé€‚é…é€»è¾‘

ç©ºé—´ä¸»é¡µ (`https://space.bilibili.com/*`) çš„é€‚é…é€»è¾‘é€šè¿‡ `spacePageLogic()` å‡½æ•°å®ç°ã€‚ç©ºé—´ä¸»é¡µçš„ DOM ç»“æ„ç›¸å¯¹å¤æ‚ä¸”å¤šå˜ã€‚

## æµç¨‹æ¦‚è¿°

ç©ºé—´ä¸»é¡µçš„é€‚é…é€»è¾‘ä¹Ÿæ˜¯åœ¨ `DOMContentLoaded` ååˆå§‹åŒ–ï¼Œå¹¶ä¾èµ– `handleCards()` å‡½æ•°å¤„ç†ç°æœ‰å¡ç‰‡ï¼Œä»¥åŠ `MutationObserver` å’Œæ»šåŠ¨ç›‘å¬å¤„ç†åŠ¨æ€åŠ è½½çš„æ–°å¡ç‰‡ã€‚

## å¡ç‰‡é€‰æ‹©ä¸æ•°æ®æå–

-   **é€‰æ‹©ç­–ç•¥ï¼š** ç”±äºç©ºé—´ä¸»é¡µçš„è§†é¢‘å¡ç‰‡ç±»åå’Œç»“æ„å¤šæ ·ï¼ˆå¦‚ `.bili-video-card` å’Œ `.bili-cover-card` éƒ½å¯èƒ½å‡ºç°ï¼Œæˆ–è€…æœ‰å…¶ä»–è‡ªå®šä¹‰ç»“æ„ï¼‰ï¼Œè„šæœ¬é‡‡å–äº†å…ˆå¯»æ‰¾å¯èƒ½çš„ç»Ÿè®¡å®¹å™¨ï¼Œç„¶åå‘ä¸Š/å‘ä¾§è¾¹éå† DOM æ¥æŸ¥æ‰¾ç›¸å…³è”çš„è§†é¢‘é“¾æ¥å’Œ BVID çš„ç­–ç•¥ã€‚
-   è„šæœ¬ä½¿ç”¨æ‰©å±•çš„é€‰æ‹©å™¨æ¥æŸ¥æ‰¾å¯èƒ½çš„ç»Ÿè®¡å®¹å™¨ï¼š`.bili-video-card__stats--left, .bili-cover-card__stats, .info .watch-info, .stat, .card-item .count, .info, .meta, .metrics, .count-info, .number, .info-count`ã€‚
-   **æ•°æ®æå–çš„å…³é”®ç‚¹ï¼š** ä»æ‰¾åˆ°çš„ç»Ÿè®¡å®¹å™¨å¼€å§‹ï¼Œè„šæœ¬ä¼šå‘ä¸Šéå†çˆ¶å…ƒç´ ï¼ŒåŒæ—¶æ£€æŸ¥å½“å‰å…ƒç´ æˆ–å…¶å­å…ƒç´ æ˜¯å¦æ˜¯åŒ…å« BVID çš„é“¾æ¥ (`<a>` æ ‡ç­¾)ã€‚ä½¿ç”¨äº†å¤šä¸ªé“¾æ¥æ¨¡å¼ (`a[href*="/video/BV"], a[data-aid], a[data-bvid]`) æ¥æé«˜åŒ¹é…æˆåŠŸç‡ã€‚
-   ä½¿ç”¨ `processedStatsContainers` Set é›†åˆè¿½è¸ªå·²å¤„ç†çš„ç»Ÿè®¡å®¹å™¨ï¼Œé¿å…é‡å¤å¤„ç†ã€‚

## æ•°æ®è·å–ä¸UIæ³¨å…¥

-   æ‰¾åˆ°ç»Ÿè®¡å®¹å™¨å’Œå¯¹åº”çš„ BVID åï¼Œå¼‚æ­¥è°ƒç”¨ `fetchFullStats(bvid)` è·å–ç»Ÿè®¡æ•°æ®ã€‚
-   è·å–åˆ°ç»Ÿè®¡æ•°æ®åï¼Œè„šæœ¬ç›´æ¥åœ¨ `spacePageLogic` å‡½æ•°å†…éƒ¨è¿›è¡Œ UI å…ƒç´ çš„åˆ›å»ºå’Œæ³¨å…¥ï¼ˆæ²¡æœ‰ä½¿ç”¨ç‹¬ç«‹çš„ `BiliRatingUI` æ–¹æ³•ï¼‰ã€‚
-   åˆ›å»ºç”¨äºæ˜¾ç¤ºè¯„çº§çš„ `<span>` å…ƒç´ ï¼Œå¹¶èµ‹äºˆ `.bili-health-rating-span` ç±»åã€‚
-   è·å–ç°æœ‰ç»Ÿè®¡å…ƒç´ çš„å¤§å°å‚è€ƒå¹¶åº”ç”¨åˆ°æ–°çš„è¯„åˆ† `<span>` å’Œ SVG å›¾æ ‡ä¸Šï¼Œå®ç°å¤§å°è‡ªé€‚åº”ã€‚
-   å°†è®¡ç®—å‡ºçš„å¥½è¯„ç‡å’Œè¯„çº§æ–‡æœ¬åŠé¢œè‰²ç±»åå¡«å……åˆ° `<span>` çš„ `innerHTML` ä¸­ã€‚
-   **æ’å…¥é€»è¾‘ï¼š** è·å–ç»Ÿè®¡å®¹å™¨å†…æ‰€æœ‰çš„å­å…ƒç´  (`statsContainer.children`)ã€‚æ ¹æ®å­å…ƒç´ ï¼ˆç»Ÿè®¡é¡¹ï¼‰çš„æ•°é‡å†³å®šæ’å…¥ä½ç½®ï¼š
    -   å¦‚æœç»Ÿè®¡å…ƒç´ æ•°é‡ä¸º 2ï¼Œæ’å…¥åˆ°ç¬¬äºŒä¸ªç»Ÿè®¡å…ƒç´ ä¹‹å‰ã€‚
    -   å¦‚æœç»Ÿè®¡å…ƒç´ æ•°é‡å¤§äºç­‰äº 3ï¼Œæ’å…¥åˆ°ç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªç»Ÿè®¡å…ƒç´ ä¹‹é—´ã€‚
    -   å¦‚æœç»Ÿè®¡å…ƒç´ æ•°é‡å°‘äº 2ï¼Œè¿½åŠ åˆ°æœ«å°¾ã€‚

ç©ºé—´ä¸»é¡µçš„é€‚é…é€»è¾‘ç”±äºé¡µé¢ç»“æ„çš„å¤šæ ·æ€§è€Œç›¸å¯¹å¤æ‚ï¼Œé€šè¿‡å…ˆå®šä½ç»Ÿè®¡å®¹å™¨å†åå‘æŸ¥æ‰¾é“¾æ¥çš„æ–¹å¼æé«˜äº†å…¼å®¹æ€§ã€‚æ’å…¥é€»è¾‘ä¹Ÿé’ˆå¯¹ç©ºé—´ä¸»é¡µå¯èƒ½å‡ºç°çš„ä¸åŒç»Ÿè®¡é¡¹æ•°é‡è¿›è¡Œäº†é€‚é…ã€‚

---

**æ–‡ä»¶ 12: docs/en/space_page_logic.md (Space Page Adaptation Logic English)**

```markdown
# Space Page Adaptation Logic

The adaptation logic for user space pages (`https://space.bilibili.com/*`) is handled by the `spacePageLogic()` function. The DOM structure on space pages can be relatively complex and varied.

## Process Overview

Similar to other pages, the space page adaptation logic initializes after `DOMContentLoaded` and relies on the `handleCards()` function to process existing cards, as well as a `MutationObserver` and scroll listener for dynamically loaded new content.

## Card Selection and Data Extraction

-   **Selection Strategy:** Due to the variety in video card class names and structures on space pages (e.g., both `.bili-video-card` and `.bili-cover-card` may appear, or other custom structures), the script adopts a strategy of first looking for potential stats containers and then traversing upwards/sideways in the DOM to find associated video links and BVIDs.
-   The script uses an expanded set of selectors to find potential stats containers: `.bili-video-card__stats--left, .bili-cover-card__stats, .info .watch-info, .stat, .card-item .count, .info, .meta, .metrics, .count-info, .number, .info-count`.
-   **Key Point for Data Extraction:** Starting from the found stats container, the script traverses up the parent elements, simultaneously checking if the current element or its children is a link (`<a>` tag) containing a BVID. Multiple link patterns (`a[href*="/video/BV"], a[data-aid], a[data-bvid]`) are used to improve the chance of finding the link.
-   A `processedStatsContainers` Set is used to track processed stats containers.

## Data Fetching and UI Injection

-   Once a stats container and its corresponding BVID are found, `fetchFullStats(bvid)` is called asynchronously to fetch the statistics.
-   After fetching the stats, the UI elements are created and injected directly within the `spacePageLogic` function itself (it doesn't use a separate `BiliRatingUI` method for injection).
-   A `<span>` element for displaying the rating is created and assigned the `.bili-health-rating-span` class.
-   Size reference is obtained from existing stat elements and applied to the new rating `<span>` and SVG icon for size adaptation.
-   The calculated good rate and rating text/color class are populated into the `innerHTML` of the `<span>`.
-   **Insertion Logic:** It gets all child elements (`statsContainer.children`) within the stats container. The insertion position is determined based on the number of child elements (stat items):
    -   If the number of stat elements is 2, insert before the second stat element.
    -   If the number of stat elements is 3 or more, insert between the second and third stat elements.
    -   If the number of stat elements is less than 2, append to the end.

The space page adaptation logic is relatively complex due to the page structure's variability. The approach of locating stats containers first and then traversing to find the link improves compatibility. The insertion logic is also adapted to handle the different number of stat items that might appear on space pages.

---

**æ–‡ä»¶ 13: docs/zh-CN/search_page_logic.md (æœç´¢é¡µé€‚é…é€»è¾‘ ä¸­æ–‡)**

```markdown
# æœç´¢é¡µé€‚é…é€»è¾‘

æœç´¢é¡µ (`https://search.bilibili.com/*`) çš„é€‚é…é€»è¾‘é€šè¿‡ `searchPageLogic()` å‡½æ•°å®ç°ã€‚æœç´¢é¡µçš„è§†é¢‘å¡ç‰‡ç»“æ„ä¸ä¸»é¡µç›¸ä¼¼ã€‚

## æµç¨‹æ¦‚è¿°

ä¸ä¸»é¡µå’Œåˆ†åŒºé¡µç±»ä¼¼ï¼Œæœç´¢é¡µçš„é€‚é…é€»è¾‘ä¹Ÿæ˜¯åœ¨ `DOMContentLoaded` ååˆå§‹åŒ–ï¼Œå¹¶ä¾èµ– `handleCards()` å‡½æ•°å¤„ç†ç°æœ‰å¡ç‰‡ï¼Œä»¥åŠ `MutationObserver` å’Œæ»šåŠ¨ç›‘å¬å¤„ç†åŠ¨æ€åŠ è½½çš„æ–°å¡ç‰‡ã€‚

## å¡ç‰‡é€‰æ‹©ä¸æ•°æ®æå–

-   è„šæœ¬ä½¿ç”¨ä¸ä¸»é¡µç›¸åŒçš„é€‰æ‹©å™¨ï¼š`document.querySelectorAll('div.bili-video-card')` æ¥é€‰æ‹©æœç´¢ç»“æœä¸­çš„è§†é¢‘å¡ç‰‡ã€‚
-   ä»å¡ç‰‡ä¸­æŸ¥æ‰¾é“¾æ¥å…ƒç´ ï¼š`card.querySelector('a, .bili-video-card__image--link')`ã€‚è¿™é‡ŒåŒ…å«äº† `a` é€‰æ‹©å™¨ï¼Œä»¥ç¡®ä¿å…¼å®¹æœç´¢é¡µå¯èƒ½å‡ºç°çš„å…¶ä»–é“¾æ¥ç»“æ„ã€‚
-   ä»é“¾æ¥å…ƒç´ çš„ `href` å±æ€§ä¸­é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼ `/bv\w{10}/i` æå– BVIDã€‚
-   ä½¿ç”¨ `processedCards` Set é›†åˆè¿½è¸ªå·²å¤„ç†å¡ç‰‡ã€‚

## æ•°æ®è·å–ä¸UIæ³¨å…¥

-   æ”¶é›†éœ€è¦å¤„ç†å¡ç‰‡çš„ BVIDï¼Œå¹¶æ‰¹é‡å¼‚æ­¥è°ƒç”¨ `fetchFullStats(bvid)` è·å–ç»Ÿè®¡æ•°æ®ã€‚
-   è·å–åˆ°ç»Ÿè®¡æ•°æ®åï¼Œè°ƒç”¨ `BiliRatingUI.addLikeRateToCard(card, new Map([[bvid, stat]]), bvid)` å‡½æ•°è¿›è¡Œ UI æ³¨å…¥ã€‚
-   `addLikeRateToCard` å‡½æ•°çš„é€»è¾‘ä¸ä¸»é¡µå®Œå…¨ç›¸åŒï¼š
    -   æŸ¥æ‰¾ç»Ÿè®¡å®¹å™¨ `.bili-video-card__stats--left`ã€‚
    -   åˆ›å»º `.bili-health-rating-span` å…ƒç´ ã€‚
    -   è·å–ç°æœ‰ç»Ÿè®¡å…ƒç´ çš„å¤§å°å‚è€ƒå¹¶åº”ç”¨åˆ°æ–°çš„è¯„åˆ† `<span>` å’Œ SVG å›¾æ ‡ä¸Šï¼Œå®ç°å¤§å°è‡ªé€‚åº”ã€‚
    -   å°†è®¡ç®—å‡ºçš„å¥½è¯„ç‡å’Œè¯„çº§æ–‡æœ¬åŠé¢œè‰²ç±»åå¡«å……åˆ° `<span>` çš„ `innerHTML` ä¸­ã€‚
    -   **ç®€å•åœ°å°†è¯„åˆ† `<span>` å…ƒç´ è¿½åŠ  (`appendChild`) åˆ°ç»Ÿè®¡å®¹å™¨çš„æœ«å°¾ã€‚**

ç”±äºæœç´¢é¡µå¡ç‰‡ç»“æ„ä¸ä¸»é¡µç›¸ä¼¼ï¼Œå› æ­¤å¤ç”¨äº†ä¸»é¡µçš„ UI æ³¨å…¥æ–¹æ³•ã€‚

---

**æ–‡ä»¶ 14: docs/en/search_page_logic.md (Search Page Adaptation Logic English)**

```markdown
# Search Page Adaptation Logic

The adaptation logic for search pages (`https://search.bilibili.com/*`) is handled by the `searchPageLogic()` function. The structure of video cards on search pages is similar to the homepage.

## Process Overview

Similar to the homepage and region pages, the search page adaptation logic initializes after `DOMContentLoaded` and relies on the `handleCards()` function for existing cards, as well as a `MutationObserver` and scroll listener for dynamically loaded new cards.

## Card Selection and Data Extraction

-   The script uses the same selector as the homepage: `document.querySelectorAll('div.bili-video-card')` to select video cards in the search results.
-   It finds the link element within the card using `card.querySelector('a, .bili-video-card__image--link')`. The inclusion of the `a` selector ensures compatibility with potentially different link structures on the search page.
-   The BVID is extracted from the `href` attribute of the link element using the regular expression `/bv\w{10}/i`.
-   A `processedCards` Set is used to track processed cards.

## Data Fetching and UI Injection

-   BVIDs from cards needing processing are collected, and `fetchFullStats(bvid)` is called asynchronously in batch to get the statistics.
-   Once the statistics are fetched, the `BiliRatingUI.addLikeRateToCard(card, new Map([[bvid, stat]]), bvid)` function is called to inject the UI.
-   The logic of the `addLikeRateToCard` function is identical to the homepage:
    -   It finds the stats container `.bili-video-card__stats--left`.
    -   It creates the `.bili-health-rating-span` element.
    -   It gets the size reference from existing stat elements and applies it to the new rating `<span>` and SVG icon for size adaptation.
    -   It populates the `innerHTML` of the `<span>` with the calculated good rate and rating text/color class.
    -   **It simply appends (`appendChild`) the rating `<span>` element to the end of the stats container.**

Since the search page card structure is similar to the homepage, the UI injection method from the homepage is reused.

---

**æ–‡ä»¶ 15: docs/zh-CN/video_page_logic.md (è§†é¢‘è¯¦æƒ…é¡µé€‚é…é€»è¾‘ ä¸­æ–‡)**

```markdown
# è§†é¢‘è¯¦æƒ…é¡µé€‚é…é€»è¾‘

è§†é¢‘è¯¦æƒ…é¡µ (`https://www.bilibili.com/video/*`) çš„é€‚é…é€»è¾‘é€šè¿‡ `videoPageLogic()` å‡½æ•°è°ƒç”¨ `BiliRatingUI.initVideoPageLogic()` æ¥å®ç°ã€‚è§†é¢‘è¯¦æƒ…é¡µä¸å¡ç‰‡é¡µé¢çš„ç»“æ„å®Œå…¨ä¸åŒï¼Œæ•°æ®è·å–å’Œ UI æ³¨å…¥æ–¹å¼ä¹Ÿä¸åŒã€‚

## æµç¨‹æ¦‚è¿°

1.  åœ¨ `DOMContentLoaded` äº‹ä»¶è§¦å‘ååˆå§‹åŒ–ã€‚
2.  æ£€æŸ¥é¡µé¢å…¨å±€å˜é‡ `unsafeWindow.__INITIAL_STATE__` ä¸­æ˜¯å¦åŒ…å«è§†é¢‘ç»Ÿè®¡æ•°æ®ã€‚
3.  æ³¨å…¥è§†é¢‘è¯¦æƒ…é¡µç‰¹æœ‰çš„ CSS æ ·å¼ï¼Œè°ƒæ•´å·¥å…·æ å…ƒç´ çš„å¸ƒå±€å’Œé—´è·ã€‚
4.  ç›´æ¥ä» `unsafeWindow.__INITIAL_STATE__.videoData.stat` è·å–è§†é¢‘ç»Ÿè®¡æ•°æ®ã€‚
5.  è®¡ç®—å„é¡¹æ¯”ç‡ã€å¥½è¯„ç‡å’Œè¯„çº§ã€‚
6.  åˆ›å»ºç”¨äºå±•ç¤ºå„é¡¹æ¯”ç‡ã€ç»¼åˆè¯„çº§å’Œå¥½è¯„ç‡çš„ç‹¬ç«‹ `div` å…ƒç´ ã€‚
7.  ä½¿ç”¨ `MutationObserver` ç›‘å¬å·¥å…·æ å…ƒç´ çš„å‡ºç°ï¼Œå¹¶åœ¨å·¥å…·æ å‡†å¤‡å°±ç»ªåå°†åˆ›å»ºçš„ `div` å…ƒç´ æ’å…¥åˆ°å¯¹åº”çš„ä½ç½®ï¼ˆå¦‚ç‚¹èµã€æŠ•å¸ã€æ”¶è—ã€åˆ†äº«æŒ‰é’®æ—è¾¹ï¼Œä»¥åŠå·¥å…·æ å·¦ä¾§ï¼‰ã€‚
8.  æ·»åŠ "å¤åˆ¶è¯„çº§"æŒ‰é’®åŠŸèƒ½ã€‚
9.  ç›‘å¬è§†é¢‘çš„ BVID å˜åŒ–ï¼ˆä¾‹å¦‚åœ¨æ’­æ”¾åˆ—è¡¨åˆ‡æ¢è§†é¢‘æ—¶ï¼‰ï¼Œå¹¶åœ¨ BVID å˜åŒ–æ—¶æ›´æ–°æ˜¾ç¤ºçš„è¯„çº§ä¿¡æ¯ã€‚

## æ•°æ®è·å–

ä¸å¡ç‰‡é¡µé¢é€šè¿‡ API å¼‚æ­¥è·å–æ•°æ®ä¸åŒï¼Œè§†é¢‘è¯¦æƒ…é¡µç›´æ¥ä»é¡µé¢åŠ è½½æ—¶å·²æœ‰çš„å…¨å±€ JavaScript å˜é‡ `unsafeWindow.__INITIAL_STATE__.videoData.stat` ä¸­è·å–ç»Ÿè®¡æ•°æ®ã€‚è¿™æ˜¯ä¸€ç§æ›´ç›´æ¥å’Œå¿«é€Ÿçš„æ–¹å¼ã€‚

```javascript
const videoStatData = unsafeWindow.__INITIAL_STATE__.videoData.stat;
```

## UI æ³¨å…¥

è§†é¢‘è¯¦æƒ…é¡µçš„ UI æ³¨å…¥ä¸æ˜¯åœ¨ç°æœ‰å¡ç‰‡ç»“æ„ä¸­æ’å…¥å…ƒç´ ï¼Œè€Œæ˜¯åˆ›å»ºæ–°çš„ `div` å…ƒç´ æ¥å±•ç¤ºä¿¡æ¯ï¼Œå¹¶å°†è¿™äº› `div` æ·»åŠ åˆ°é¡µé¢å¸ƒå±€ä¸­ã€‚

-   ä¸ºç‚¹èµã€æŠ•å¸ã€æ”¶è—ã€åˆ†äº«åˆ†åˆ«åˆ›å»º `div`ï¼Œæ˜¾ç¤ºå…¶ç›¸å¯¹äºæ’­æ”¾é‡çš„æ¯”ç‡ã€‚
-   åˆ›å»º `.comprehensive-rating` `div` æ˜¾ç¤ºç»¼åˆè¯„çº§æ–‡æœ¬å’Œé¢œè‰²ã€‚
-   åˆ›å»º `.good-rate` `div` æ˜¾ç¤ºå¥½è¯„ç‡æ•°å€¼å’Œé¢œè‰²ã€‚
-   åˆ›å»º `.copy-rating` `div` ä½œä¸ºå¤åˆ¶è¯„çº§æ–‡æœ¬çš„æŒ‰é’®ã€‚

è¿™äº› `div` å…ƒç´ é€šè¿‡ `MutationObserver` ç¡®ä¿åœ¨è§†é¢‘å·¥å…·æ ç›¸å…³å…ƒç´ åŠ è½½å®Œæˆåï¼Œè¢«ç²¾ç¡®åœ°æ’å…¥åˆ°å·¥å…·æ çš„ä¸åŒä½ç½®ã€‚

## å¤åˆ¶è¯„çº§åŠŸèƒ½

"å¤åˆ¶è¯„çº§"æŒ‰é’®ç‚¹å‡»åï¼Œä¼šä½¿ç”¨ `navigator.clipboard.writeText` å°† `BiliRating.getPlainText()` å‡½æ•°ç”Ÿæˆçš„çº¯æ–‡æœ¬è¯„çº§æè¿°å¤åˆ¶åˆ°ç”¨æˆ·çš„å‰ªè´´æ¿ã€‚

## åŠ¨æ€æ›´æ–°

é€šè¿‡ç›‘å¬ `unsafeWindow.__INITIAL_STATE__.videoData.bvid` çš„å˜åŒ–ï¼Œè„šæœ¬èƒ½å¤Ÿåœ¨ç”¨æˆ·åœ¨æ’­æ”¾åˆ—è¡¨æˆ–é€‰é›†ä¹‹é—´åˆ‡æ¢è§†é¢‘æ—¶ï¼Œè‡ªåŠ¨æ›´æ–°é¡µé¢ä¸Šæ˜¾ç¤ºçš„è¯„çº§ä¿¡æ¯ï¼Œæ— éœ€åˆ·æ–°é¡µé¢ã€‚

ç”±äºè§†é¢‘è¯¦æƒ…é¡µçš„ç»“æ„å’Œæ•°æ®æ¥æºçš„ç‹¬ç‰¹æ€§ï¼Œå…¶é€‚é…é€»è¾‘æ˜¯ä¸€ä¸ªç‹¬ç«‹äºå¡ç‰‡é¡µé¢å¤„ç†æµç¨‹çš„éƒ¨åˆ†ã€‚

---

**æ–‡ä»¶ 16: docs/en/video_page_logic.md (Video Detail Page Adaptation Logic English)**

```markdown
# Video Detail Page Adaptation Logic

The adaptation logic for video detail pages (`https://www.bilibili.com/video/*`) is handled by the `videoPageLogic()` function which calls `BiliRatingUI.initVideoPageLogic()`. The structure of video detail pages is completely different from card pages, and so are the data fetching and UI injection methods.

## Process Overview

1.  Initializes after the `DOMContentLoaded` event fires.
2.  Checks if video statistics data is available in the global variable `unsafeWindow.__INITIAL_STATE__`.
3.  Injects CSS styles specific to the video detail page to adjust the layout and spacing of toolbar elements.
4.  Fetches video statistics directly from `unsafeWindow.__INITIAL_STATE__.videoData.stat`.
5.  Calculates individual ratios, the good rate, and the overall rating.
6.  Creates separate `div` elements to display individual ratios, the overall rating, and the good rate.
7.  Uses a `MutationObserver` to watch for the appearance of toolbar elements and inserts the created `div` elements into their respective positions (e.g., next to the like, coin, favorite, share buttons, and on the left side of the toolbar) once the toolbar is ready.
8.  Adds the "Copy Rating" button functionality.
9.  Listens for changes in the video's BVID (e.g., when switching videos in a playlist) and updates the displayed rating information automatically without requiring a page refresh.

## Data Fetching

Unlike card pages which fetch data asynchronously via API, the video detail page directly retrieves statistics from the global JavaScript variable `unsafeWindow.__INITIAL_STATE__.videoData.stat`, which is available when the page loads. This is a more direct and faster approach.

```javascript
const videoStatData = unsafeWindow.__INITIAL_STATE__.videoData.stat;
```

## UI Injection

UI injection on the video detail page does not involve inserting elements into existing card structures. Instead, new `div` elements are created to display the information, and these `div`s are added to the page layout.

-   `div` elements are created for like, coin, favorite, and share counts, displaying their ratio relative to views.
-   A `.comprehensive-rating` `div` is created to display the overall rating text and color.
-   A `.good-rate` `div` is created to display the numerical good rate and color.
-   A `.copy-rating` `div` serves as a button to copy the rating text.

These `div` elements are precisely inserted into different locations within the video toolbar using a `MutationObserver` to ensure they are added after the relevant toolbar elements have loaded.

## Copy Rating Functionality

When clicked, the "Copy Rating" button uses `navigator.clipboard.writeText` to copy the plain text rating description generated by the `BiliRating.getPlainText()` function to the user's clipboard.

## Dynamic Updates

By observing changes in `unsafeWindow.__INITIAL_STATE__.videoData.bvid`, the script can automatically update the displayed rating information when the user switches between videos in a playlist or episode selection, without needing a page refresh.

Due to the unique structure and data source of the video detail page, its adaptation logic is a separate part from the card page processing flow.

---

**æ–‡ä»¶ 17: docs/zh-CN/event_handling.md (åŠ¨æ€å†…å®¹ä¸äº‹ä»¶å¤„ç† ä¸­æ–‡)**

```markdown
# åŠ¨æ€å†…å®¹ä¸äº‹ä»¶å¤„ç†

Bilibili ç½‘ç«™å¤§é‡ä½¿ç”¨æ‡’åŠ è½½ï¼ˆLazy Loadingï¼‰å’ŒåŠ¨æ€å†…å®¹æ›´æ–°ï¼ˆé€šè¿‡ AJAX æˆ–å…¶ä»– JavaScript æ“ä½œï¼‰ã€‚ä¸ºäº†ç¡®ä¿"ä¸€é”®ä¸‰è¿å¥åº·æ¢é’ˆ"è„šæœ¬èƒ½å¤Ÿå¤„ç†è¿™äº›åŠ¨æ€åŠ è½½çš„è§†é¢‘å¡ç‰‡ï¼Œè„šæœ¬åœ¨å„ç§é¡µé¢é€‚é…é€»è¾‘ä¸­éƒ½åŒ…å«äº†äº‹ä»¶ç›‘å¬å’Œ DOM å˜åŒ–è§‚å¯Ÿæœºåˆ¶ã€‚

## MutationObserver

åœ¨ä¸»é¡µã€åˆ†åŒºé¡µã€æœç´¢é¡µå’Œç©ºé—´ä¸»é¡µç­‰åŒ…å«åŠ¨æ€å¡ç‰‡çš„é¡µé¢é€»è¾‘ä¸­ï¼Œè„šæœ¬ä½¿ç”¨äº† `MutationObserver` æ¥ç›‘å¬é¡µé¢ DOM çš„å˜åŒ–ã€‚

```javascript
const observer = new MutationObserver((mutations) => {
    let shouldHandle = false;
    for (const mutation of mutations) {
        if (mutation.type === 'childList') { // ç›‘å¬å­èŠ‚ç‚¹çš„å¢åˆ 
            for (const node of mutation.addedNodes) { // éå†æ‰€æœ‰è¢«æ·»åŠ çš„èŠ‚ç‚¹
                // æ£€æŸ¥è¢«æ·»åŠ çš„èŠ‚ç‚¹æœ¬èº«æˆ–å…¶å­èŠ‚ç‚¹æ˜¯å¦æ˜¯è§†é¢‘å¡ç‰‡æˆ–åŒ…å«ç»Ÿè®¡ä¿¡æ¯ï¼ˆä½¿ç”¨æ‰©å±•çš„é€‰æ‹©å™¨ï¼‰
                if (node.nodeType === Node.ELEMENT_NODE &&
                    (node.matches(/** å„ç§å¡ç‰‡å’Œç»Ÿè®¡å®¹å™¨é€‰æ‹©å™¨ **/) ||
                     node.querySelector(/** å„ç§å¡ç‰‡å’Œç»Ÿè®¡å®¹å™¨é€‰æ‹©å™¨ **/))) {
                    shouldHandle = true;
                    break; // å‘ç°ç›¸å…³èŠ‚ç‚¹ï¼Œæ ‡è®°éœ€è¦å¤„ç†
                }
            }
        }
        if (shouldHandle) break; // å¦‚æœå·²ç»æ ‡è®°éœ€è¦å¤„ç†ï¼Œåœæ­¢æ£€æŸ¥å…¶ä»–å˜åŒ–
    }

    if (shouldHandle) {
        // ä½¿ç”¨ setTimeout è¿›è¡Œé˜²æŠ–å¤„ç†ï¼Œé¿å…åœ¨å¤§é‡DOMå˜åŒ–æ—¶é¢‘ç¹è§¦å‘
        setTimeout(handleCards, 50); // å»¶è¿Ÿä¸€å®šæ—¶é—´æ‰§è¡Œå¡ç‰‡å¤„ç†å‡½æ•°
    }
});

// å¼€å§‹è§‚å¯Ÿ document.body åŠå…¶æ‰€æœ‰å­å­™èŠ‚ç‚¹
observer.observe(document.body, {
    childList: true, // è§‚å¯Ÿå­èŠ‚ç‚¹çš„å¢åˆ 
    subtree: true,   // è§‚å¯Ÿæ‰€æœ‰å­å­™èŠ‚ç‚¹
    // attributes: true // ä¹Ÿå¯ä»¥è§‚å¯Ÿå±æ€§å˜åŒ–ï¼Œä½†å¯¹äºæ–°å…ƒç´ æ£€æµ‹ childList+subtree æ›´é‡è¦
});
```

`MutationObserver` é…ç½®ä¸ºç›‘å¬ `document.body` çš„ `childList` å’Œ `subtree` å˜åŒ–ã€‚å½“é€šè¿‡æ»šåŠ¨åŠ è½½æˆ–é¡µé¢å…¶ä»–äº¤äº’æ·»åŠ äº†æ–°çš„åŒ…å«è§†é¢‘å¡ç‰‡æˆ–ç»Ÿè®¡ä¿¡æ¯çš„å…ƒç´ æ—¶ï¼Œ`MutationObserver` çš„å›è°ƒå‡½æ•°ä¼šè¢«è§¦å‘ã€‚è„šæœ¬ä¼šåœ¨å›è°ƒå‡½æ•°ä¸­åˆ¤æ–­æ˜¯å¦æœ‰ç›¸å…³çš„èŠ‚ç‚¹è¢«æ·»åŠ ï¼Œå¹¶ä½¿ç”¨ `setTimeout` è¿›è¡Œé˜²æŠ–å¤„ç†åï¼Œè°ƒç”¨ `handleCards` å‡½æ•°æ¥å¤„ç†è¿™äº›æ–°å‡ºç°çš„å¡ç‰‡ã€‚

## æ»šåŠ¨äº‹ä»¶ç›‘å¬

ä½œä¸º `MutationObserver` çš„è¡¥å……ï¼Œè„šæœ¬è¿˜åœ¨è¿™äº›é¡µé¢ç›‘å¬äº† `window` çš„ `scroll` äº‹ä»¶ã€‚

```javascript
let scrollTimer = null; // ç”¨äºé˜²æŠ–çš„è®¡æ—¶å™¨
window.addEventListener('scroll', () => {
     // é˜²æŠ–å¤„ç†ï¼šå¦‚æœåœ¨çŸ­æ—¶é—´å†…å†æ¬¡æ»šåŠ¨ï¼Œå–æ¶ˆä¹‹å‰çš„å¤„ç†è®¡åˆ’
     if (scrollTimer) clearTimeout(scrollTimer);
     scrollTimer = setTimeout(() => {
         // æ»šåŠ¨åœæ­¢ä¸€æ®µæ—¶é—´åï¼Œæ‰§è¡Œå¡ç‰‡å¤„ç†å‡½æ•°
         console.log("[BiliHealth Scan] Triggering handleCards due to scroll.");
         handleCards();
     }, 100); // è®¾ç½®ä¸€ä¸ªé˜²æŠ–å»¶è¿Ÿ
});
```

ç”±äº Bilibili çš„æ‡’åŠ è½½æœ‰æ—¶ä¸æ»šåŠ¨ç´§å¯†å…³è”ï¼Œæ»šåŠ¨äº‹ä»¶ç›‘å¬å™¨æä¾›äº†ä¸€ä¸ªé¢å¤–çš„è§¦å‘æœºä¼šã€‚é€šè¿‡è®¾ç½®ä¸€ä¸ªå°çš„é˜²æŠ–å»¶è¿Ÿï¼Œå¯ä»¥é¿å…åœ¨ç”¨æˆ·æŒç»­æ»šåŠ¨æ—¶é¢‘ç¹è§¦å‘å¤„ç†å‡½æ•°ï¼Œæé«˜æ•ˆç‡ã€‚

## å¤„ç†å·²å¤„ç†å…ƒç´ 

ä¸ºäº†é˜²æ­¢å¯¹åŒä¸€ä¸ªè§†é¢‘å¡ç‰‡æˆ–ç»Ÿè®¡å®¹å™¨é‡å¤æ³¨å…¥è¯„çº§ï¼Œè„šæœ¬åœ¨æ¯ä¸ªé¡µé¢çš„å¤„ç†å‡½æ•°ä¸­éƒ½ä½¿ç”¨äº† `Set` é›†åˆ (`processedCards` æˆ– `processedStatsContainers`) æ¥è®°å½•å·²ç»å¤„ç†è¿‡çš„å…ƒç´ ã€‚åœ¨å¤„ç†æ–°å‘ç°çš„å…ƒç´ ä¹‹å‰ï¼Œä¼šå…ˆæ£€æŸ¥å®ƒæ˜¯å¦å·²ç»åœ¨ `Set` ä¸­ï¼Œå¦‚æœæ˜¯åˆ™è·³è¿‡ã€‚

è¿™äº›æœºåˆ¶å…±åŒç¡®ä¿äº†è„šæœ¬èƒ½å¤Ÿç¨³å®šåœ°åœ¨åŠ¨æ€åŠ è½½å†…å®¹çš„ Bilibili é¡µé¢ä¸Šå·¥ä½œã€‚

---

**æ–‡ä»¶ 18: docs/en/event_handling.md (Dynamic Content and Event Handling English)**

```markdown
# Dynamic Content and Event Handling

The Bilibili website heavily utilizes lazy loading and dynamic content updates (via AJAX or other JavaScript operations). To ensure the "BiliHealth Scan" script can handle these dynamically loaded video cards, the script includes event listeners and DOM change observation mechanisms in its various page adaptation logics.

## MutationObserver

In the logic for pages containing dynamic cards, such as the homepage, region pages, search pages, and space pages, the script uses a `MutationObserver` to listen for changes in the page's DOM.

```javascript
const observer = new MutationObserver((mutations) => {
    let shouldHandle = false;
    for (const mutation of mutations) {
        if (mutation.type === 'childList') { // Listen for added or removed child nodes
            for (const node of mutation.addedNodes) { // Iterate through all added nodes
                // Check if the added node itself or its descendants are video cards or contain stats (using expanded selectors)
                if (node.nodeType === Node.ELEMENT_NODE &&
                    (node.matches(/** various card and stats container selectors **/) ||
                     node.querySelector(/** various card and stats container selectors **/))) {
                    shouldHandle = true;
                    break; // Found a relevant node, flag for processing
                }
            }
        }
        if (shouldHandle) break; // If already flagged for processing, stop checking other mutations
    }

    if (shouldHandle) {
        // Use setTimeout for debouncing to avoid frequent triggers during extensive DOM changes
        setTimeout(handleCards, 50); // Delay execution of the card handling function
    }
});

// Start observing document.body and all its descendants
observer.observe(document.body, {
    childList: true, // Observe additions/removals of child nodes
    subtree: true,   // Observe all descendant nodes
    // attributes: true // Can also observe attribute changes, but childList+subtree is more important for new element detection
});
```

The `MutationObserver` is configured to watch for `childList` and `subtree` changes on `document.body`. When new elements containing video cards or statistics are added (e.g., via scroll-triggered loading or other page interactions), the `MutationObserver`'s callback function is triggered. Within the callback, the script checks if relevant nodes were added and, after a debounce delay using `setTimeout`, calls the `handleCards` function to process these newly appeared cards.

## Scroll Event Listener

Complementing the `MutationObserver`, the script also listens for the `scroll` event on the `window` on these pages.

```javascript
let scrollTimer = null; // Timer for debouncing
window.addEventListener('scroll', () => {
     // Debounce: If scrolling occurs again within a short period, cancel the previous scheduled processing
     if (scrollTimer) clearTimeout(scrollTimer);
     scrollTimer = setTimeout(() => {
         // After a short delay of scrolling stopping, execute the card handling function
         console.log("[BiliHealth Scan] Triggering handleCards due to scroll.");
         handleCards();
     }, 100); // Set a debounce delay
});
```

Since Bilibili's lazy loading is often closely tied to scrolling, the scroll event listener provides an additional trigger opportunity. By setting a small debounce delay, it prevents frequent triggers of the handling function while the user is continuously scrolling, improving efficiency.

## Tracking Processed Elements

To prevent injecting ratings into the same video card or stats container multiple times, the script uses a `Set` (`processedCards` or `processedStatsContainers`) in each page's handling function to record elements that have already been processed. Before processing a newly found element, it first checks if it's already in the `Set`; if so, it skips processing.

These mechanisms collectively ensure that the script reliably works on Bilibili pages with dynamically loaded content.

---

è¯·å°†è¿™äº›å†…å®¹å¤åˆ¶ç²˜è´´åˆ°å¯¹åº”çš„ Markdown æ–‡ä»¶ä¸­ï¼Œå¹¶æ ¹æ®æ‚¨çš„å®é™… GitHub ä»“åº“å’Œ Greasyfork è„šæœ¬åœ°å€æ›¿æ¢å ä½ç¬¦ `[æ‚¨çš„ GitHub ä»“åº“åœ°å€ Placeholder]` å’Œ `[æ‚¨çš„ Greasyfork è„šæœ¬åœ°å€ Placeholder]`ã€‚

è¿™æ ·æ‚¨çš„é¡¹ç›®æ–‡æ¡£å°±æœ‰äº†æ¸…æ™°çš„ç»“æ„å’Œè¯¦ç»†çš„æŠ€æœ¯è¯´æ˜ï¼Œä¾¿äºå…¶ä»–ç”¨æˆ·å’Œè´¡çŒ®è€…ç†è§£ã€‚
